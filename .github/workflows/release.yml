name: Release

on:
  release:
    types: [created]

jobs:
  build-release:
    name: Build Release
    runs-on: macos-14
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Show Swift version
        run: swift --version

      - name: Resolve dependencies
        run: swift package resolve

      - name: Build release binary
        run: swift build -c release

      - name: Create app bundle
        run: |
          APP_NAME="Protokoll"
          BUNDLE_ID="com.redaksjon.protokoll"
          VERSION="${{ github.event.release.tag_name }}"
          
          # Remove 'v' prefix if present
          VERSION="${VERSION#v}"
          
          echo "ðŸ“¦ Creating app bundle for version ${VERSION}..."
          
          # Create app bundle structure
          APP_DIR="${APP_NAME}.app"
          rm -rf "$APP_DIR"
          
          mkdir -p "$APP_DIR/Contents/MacOS"
          mkdir -p "$APP_DIR/Contents/Resources"
          
          # Copy executable
          cp .build/release/Protokoll "$APP_DIR/Contents/MacOS/${APP_NAME}"
          
          # Create Info.plist
          cat > "$APP_DIR/Contents/Info.plist" << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>${APP_NAME}</string>
              <key>CFBundleIdentifier</key>
              <string>${BUNDLE_ID}</string>
              <key>CFBundleName</key>
              <string>${APP_NAME}</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleShortVersionString</key>
              <string>${VERSION}</string>
              <key>CFBundleVersion</key>
              <string>${VERSION}</string>
              <key>LSMinimumSystemVersion</key>
              <string>14.0</string>
              <key>NSHighResolutionCapable</key>
              <true/>
              <key>NSSupportsAutomaticGraphicsSwitching</key>
              <true/>
              <key>NSPrincipalClass</key>
              <string>NSApplication</string>
              <key>LSApplicationCategoryType</key>
              <string>public.app-category.productivity</string>
          </dict>
          </plist>
          EOF
          
          # Make executable
          chmod +x "$APP_DIR/Contents/MacOS/${APP_NAME}"
          
          echo "âœ… App bundle created: ${APP_DIR}"

      - name: Create ZIP archive
        run: |
          APP_NAME="Protokoll"
          ZIP_NAME="Protokoll-${GITHUB_REF#refs/tags/}.zip"
          ZIP_NAME="${ZIP_NAME//v/}"  # Remove 'v' prefix if present
          
          ditto -c -k --keepParent "${APP_NAME}.app" "$ZIP_NAME"
          echo "âœ… Created archive: $ZIP_NAME"
          ls -lh "$ZIP_NAME"

      - name: Upload release asset
        uses: softprops/action-gh-release@v2
        with:
          files: |
            Protokoll-*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
